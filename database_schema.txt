use test;

-- Student accounts
CREATE TABLE Student(
	net_id VARCHAR(64) PRIMARY KEY,
	passwd VARCHAR(64) NOT NULL,
	email_addr VARCHAR(64) NOT NULL,

	ruid INT NOT NULL,

	major VARCHAR(64) NOT NULL,
	credits INTEGER NOT NULL,
	gpa REAL NOT NULL,
	grad_year INTEGER NOT NULL
);

-- Courses that students have taken/are taking
-- cid is NOT a foreign key
CREATE TABLE Registered_course(
	cid INT,
	net_id VARCHAR(64),
	grade REAL,

	PRIMARY KEY(cid, net_id),
	FOREIGN KEY(net_id) REFERENCES Student(net_id)
		ON DELETE CASCADE
		ON UPDATE CASCADE
);

-- Professor accounts
CREATE TABLE Professor(
	net_id VARCHAR(64) PRIMARY KEY,
	passwd VARCHAR(64) NOT NULL,
	email_addr VARCHAR(64) NOT NULL,
);

-- Students' special permission requests
CREATE TABLE Request(
	cid INT,
	net_id INT,

	status,			-- status of request
	rating REAL,
	ts TIMESTAMP,
	first INT,		-- first choice section
	second INT,		-- second choice
	third INT,		-- third choice
	comment VARCHAR(5000),
	PRIMARY KEY(cid, net_id),
	FOREIGN KEY(cid) REFERENCES Course(cid)
		ON DELETE CASCADE
		ON UPDATE CASCADE,
	FOREIGN KEY(net_id) REFERENCES Student(net_id)
		ON DELETE CASCADE
		ON UPDATE CASCADE
);

-- Special permission numbers that prof manages
-- 10 numbers per section
CREATE TABLE Special_permission_num(
	cid INT,
	section_num INT,
	sp_num INT,

	prof VARCHAR(64) NOT NULL,
	stud VARCHAR(64),
	status,

	PRIMARY KEY(cid, section_num, sp_num),
	FOREIGN KEY(cid) REFERENCES Course_section(cid)
		ON DELETE CASCADE
		ON UPDATE CASCADE,
	FOREIGN KEY(section_num) REFERENCES Course_section(cid)
		ON DELETE CASCADE
		ON UPDATE CASCADE,
	FOREIGN KEY(prof) REFERENCES Professor(net_id)
		ON DELETE CASCADE
		ON UPDATE CASCADE,
	FOREIGN KEY(stud) REFERENCES Student(net_id)
		ON DELETE SET NULL
		ON UPDATE CASCADE
);

-- Course sections
-- cid is in the form: XXXYYY, where xxx is the department number
-- and yyy is course number
CREATE TABLE Course_section(
	cid INT,
	section_num INT,

	prof VARCHAR(64) NOT NULL,
	max_students INT NOT NULL,
	num_students INT NOT NULL,

	PRIMARY KEY(cid, section_num),
	FOREIGN KEY(prof) REFERENCES Professor(net_id)
		ON DELETE CASCADE
		ON UPDATE CASCADE
);

-- Prerequisites
CREATE TABLE Prerequisite(
	cid INT,
	set_id INT,
	prereq INT,

	PRIMARY KEY(cid, set_id, prereq),
	FOREIGN KEY(cid) REFERENCES Course_section(cid)
		ON DELETE CASCADE
		ON UPDATE CASCADE
)

-- Needs constraint: every room must meet in at least one location
-- Times and locations of courses
CREATE TABLE Located_In(
	cid INT,
	section_num INT,
	room_num VARCHAR(64),
	meeting_time TIME, -- HOW TO STORE MEETING TIMES?

	PRIMARY KEY(cid, section_num, room_num, meeting_time),
	FOREIGN KEY(cid) REFERENCES Course_section(cid)
		ON DELETE CASCADE
		ON UPDATE CASCADE,
	FOREIGN KEY(section_num) REFERENCES Course_section(cid)
		ON DELETE CASCADE
		ON UPDATE CASCADE,
	FOREIGN KEY(room_num) REFERENCES Room(room_num)
		ON DELETE NO ACTION
		ON UPDATE CASCADE,
	CHECK ()
);

-- Rooms
-- Currently, building info is stored in room_num as "BUILDING-NUM"
-- ex. "HILL-252"
CREATE TABLE Room(
	room_num VARCHAR(64) PRIMARY KEY,
	max_seats INT
);